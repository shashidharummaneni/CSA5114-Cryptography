#include <stdio.h>
#include <stdint.h>
#include <inttypes.h>

/* fast modular exponentiation: computes base^exp mod mod */
uint64_t modexp(uint64_t base, uint64_t exp, uint64_t mod) {
    uint64_t result = 1;
    base %= mod;
    while (exp > 0) {
        if (exp & 1)
            result = (result * base) % mod;
        base = (base * base) % mod;
        exp >>= 1;
    }
    return result;
}

/* extended Euclidean algorithm:
   returns gcd(a,b) and sets x,y so that a*x + b*y = gcd(a,b) */
int64_t egcd(int64_t a, int64_t b, int64_t *x, int64_t *y) {
    if (b == 0) {
        *x = 1; *y = 0;
        return a;
    }
    int64_t x1, y1;
    int64_t g = egcd(b, a % b, &x1, &y1);
    *x = y1;
    *y = x1 - (a / b) * y1;
    return g;
}

/* modular inverse of a modulo m (assumes inverse exists) */
int64_t modinv(int64_t a, int64_t m) {
    int64_t x, y;
    int64_t g = egcd(a, m, &x, &y);
    if (g != 1) return -1; // inverse doesn't exist
    x %= m;
    if (x < 0) x += m;
    return x;
}

int main(void) {
    /* Given public key */
    uint64_t e = 31;
    uint64_t n = 3599;

    /* Factor n (from hint / trial): */
    uint64_t p = 59, q = 61;
    printf("n = %" PRIu64 " = %" PRIu64 " * %" PRIu64 "\n", n, p, q);

    uint64_t phi = (p - 1) * (q - 1);
    printf("phi(n) = %" PRIu64 "\n", phi);

    /* compute private exponent d */
    int64_t d = modinv((int64_t)e, (int64_t)phi);
    if (d == -1) {
        printf("Modular inverse not found; invalid public exponent.\n");
        return 1;
    }
    printf("Private exponent d = %lld\n\n", (long long)d);

    /* demonstration: encrypt and decrypt a small message m < n */
    uint64_t m = 1234; /* example plaintext (must be < n) */
    if (m >= n) {
        printf("Example message must be smaller than n.\n");
        return 1;
    }

    uint64_t ciphertext = modexp(m, e, n);
    uint64_t decrypted = modexp(ciphertext, d, n);

    printf("Example plaintext m = %" PRIu64 "\n", m);
    printf("Encrypt: c = m^e mod n = %" PRIu64 "\n", ciphertext);
    printf("Decrypt: m' = c^d mod n = %" PRIu64 "\n", decrypted);

    if (decrypted == m)
        printf("Decryption successful: m' == m\n");
    else
        printf("Decryption failed: m' != m\n");

    return 0;
}
