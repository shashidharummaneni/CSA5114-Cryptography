#include <stdio.h>
#include <stdint.h>
#include <string.h>

#define BLOCK_SIZE 16 // 128-bit blocks (for demonstration)

/* Toy block cipher: XOR block with key */
void encrypt_block(const uint8_t *input, const uint8_t *key, uint8_t *output) {
    for (int i = 0; i < BLOCK_SIZE; i++) {
        output[i] = input[i] ^ key[i];
    }
}

/* CBC-MAC function for any number of blocks */
void cbc_mac(const uint8_t *message, int num_blocks, const uint8_t *key, uint8_t *out_mac) {
    uint8_t prev[BLOCK_SIZE] = {0}; // Initialization vector (IV = 0)
    uint8_t temp[BLOCK_SIZE];

    for (int b = 0; b < num_blocks; b++) {
        // XOR input block with previous output
        for (int i = 0; i < BLOCK_SIZE; i++) {
            temp[i] = message[b * BLOCK_SIZE + i] ^ prev[i];
        }
        // Encrypt with block cipher
        encrypt_block(temp, key, prev);
    }

    memcpy(out_mac, prev, BLOCK_SIZE);
}

/* Helper to print a block in hex */
void print_block(const char *label, const uint8_t *block) {
    printf("%s: ", label);
    for (int i = 0; i < BLOCK_SIZE; i++) {
        printf("%02X", block[i]);
    }
    printf("\n");
}

int main() {
    // Secret key (unknown to attacker in a real scenario)
    uint8_t key[BLOCK_SIZE] = {
        0x10, 0x0F, 0x23, 0x45, 0xAB, 0xCD, 0xEF, 0x01,
        0x02, 0x04, 0x08, 0x16, 0x32, 0x64, 0xC8, 0xFF
    };

    // One-block message X
    uint8_t X[BLOCK_SIZE] = {
        0x01, 0x02, 0x03, 0x04, 0xA0, 0xB0, 0xC0, 0xD0,
        0x0F, 0x0E, 0x0D, 0x0C, 0x55, 0x66, 0x77, 0x88
    };

    uint8_t T[BLOCK_SIZE];
    cbc_mac(X, 1, key, T);

    print_block("Message X", X);
    print_block("MAC(X)", T);

    // Attacker constructs 2-block message: X || (X XOR T)
    uint8_t forged[BLOCK_SIZE * 2];
    memcpy(forged, X, BLOCK_SIZE);
    for (int i = 0; i < BLOCK_SIZE; i++) {
        forged[BLOCK_SIZE + i] = X[i] ^ T[i];
    }

    uint8_t forged_mac[BLOCK_SIZE];
    cbc_mac(forged, 2, key, forged_mac);

    printf("\nForged 2-block message: X || (X XOR T)\n");
    print_block("Forged MAC", forged_mac);

    if (memcmp(T, forged_mac, BLOCK_SIZE) == 0) {
        printf("\nAttack successful: MAC(X) == MAC(X || (X XOR T))\n");
    } else {
        printf("\nAttack failed (this should not happen)\n");
    }

    return 0;
}
